// ========================================
// Datei: src/app/projekte/[id]/page.tsx
// Projekt-Detail mit 5 Tabs inkl. F√∂rderung & Zahlungsanforderungen
// ========================================

'use client';

import { useEffect, useState, use } from 'react';
import { useRouter } from 'next/navigation';
import { createBrowserClient } from '@supabase/ssr';

// Detail-Komponente f√ºr Zahlungsanforderungen (inline, kann auch als separate Datei importiert werden)
// import ZahlungsanforderungDetail from '@/components/ZahlungsanforderungDetail';

// ============================================
// INTERFACES
// ============================================

interface Project {
  id: string;
  company_id: string;
  name: string;
  description: string;
  project_number: string;
  status: 'active' | 'completed' | 'archived' | 'on_hold';
  start_date: string;
  end_date: string;
  estimated_hours: number;
  budget: number;
  hourly_rate: number;
  client_name: string;
  client_contact: string;
  color: string;
  // F√∂rderfelder (NEU)
  funding_program: string | null;
  funding_reference: string | null;
  funding_approval_date: string | null;
  funding_amount: number | null;
  funding_rate: number | null;
  overhead_rate: number | null;
  funding_start_date: string | null;
  funding_end_date: string | null;
  project_manager: string | null;
  project_manager_phone: string | null;
  project_manager_email: string | null;
  // NEU: J√§hrliche Budgets und Kostenplan
  funding_yearly_budget: Record<string, number> | null;
  cost_plan: CostPlan | null;
}

// NEU: Kostenplan-Interface (vollst√§ndig nach ZIM-Anlage)
interface CostPlan {
  // 1. Personalkosten gem√§√ü Nr. 5.3.1 Buchstabe a) der Richtlinie ZIM
  personnel_costs_planned: number;
  // 2. √úbrige Kosten gem√§√ü Nr. 5.3.1 Buchstabe c) der Richtlinie ZIM
  overhead_costs_planned: number;
  // 3. Kosten f√ºr projektbezogene Auftr√§ge an Dritte gem√§√ü Nr. 5.3.1 Buchstabe b)
  third_party_costs_planned: number;
  // 4. Kosten f√ºr FuE-Auftr√§ge gem√§√ü Nr. 5.3.1 Buchstabe b)
  fue_contracts_planned: number;
  // 5. Kosten f√ºr zeitweilige Aufnahmen qualifizierten Personals gem√§√ü Nr. 5.3.1 Buchstabe b)
  temp_personnel_planned: number;
  // 6. Summe der projektbezogenen Kosten (berechnet)
  project_costs_total?: number;
  // Summe Zuwendung
  funding_total: number;
  // Legacy-Felder (f√ºr Abw√§rtskompatibilit√§t)
  third_party_funds?: number;
  own_contribution?: number;
  total_costs?: number;
}

interface WorkPackage {
  id: string;
  project_id: string;
  code: string;
  description: string;
  category: 'fundable' | 'non_fundable';
  start_date: string;
  end_date: string;
  estimated_hours: number;
  is_active: boolean;
  display_order: number;
  assignments?: WorkPackageAssignment[];
}

interface WorkPackageAssignment {
  id: string;
  work_package_id: string;
  user_profile_id: string;
  person_months: number;
  role: string;
  user_profile?: {
    name: string;
    qualification_group: string;
  };
}

interface ProjectAssignment {
  id: string;
  project_id: string;
  user_profile_id: string;
  project_employee_number: number;
  role: string;
  user_profile?: {
    id: string;
    name: string;
    qualification: string;
    qualification_group: string;
    weekly_hours_contract: number;
  };
}

interface PaymentRequest {
  id: string;
  project_id: string;
  request_number: number;
  period_start: string;
  period_end: string;
  personnel_costs: number;
  personnel_hours: number;
  overhead_costs: number;
  third_party_costs: number;
  total_eligible_costs: number;
  funding_rate_applied: number;
  requested_amount: number;
  approved_amount: number | null;
  paid_amount: number | null;
  status: 'draft' | 'calculated' | 'submitted' | 'in_review' | 'approved' | 'paid' | 'rejected' | 'partial';
  submitted_at: string | null;
  approved_at: string | null;
  paid_at: string | null;
  notes: string | null;
  created_at: string;
}

interface PaymentRequestItem {
  id?: string;
  payment_request_id?: string;
  user_profile_id: string;
  employee_number: number;
  employee_name: string;
  qualification_group: string;
  hours_by_month: Record<string, number>;
  total_hours: number;
  hourly_rate: number;
  total_costs: number;
}

interface Employee {
  id: string;
  name: string;
  qualification_group: string;
  weekly_hours_contract: number;
}

// ============================================
// HELPER FUNCTIONS
// ============================================

const formatCurrency = (amount: number | null | undefined): string => {
  if (amount === null || amount === undefined) return '-';
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
};

const formatDate = (dateStr: string | null | undefined): string => {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('de-DE');
};

const getStatusColor = (status: string): string => {
  const colors: Record<string, string> = {
    active: 'bg-green-100 text-green-800',
    completed: 'bg-blue-100 text-blue-800',
    archived: 'bg-gray-100 text-gray-800',
    on_hold: 'bg-yellow-100 text-yellow-800',
    draft: 'bg-gray-100 text-gray-800',
    calculated: 'bg-blue-100 text-blue-800',
    submitted: 'bg-yellow-100 text-yellow-800',
    in_review: 'bg-orange-100 text-orange-800',
    approved: 'bg-green-100 text-green-800',
    paid: 'bg-emerald-100 text-emerald-800',
    rejected: 'bg-red-100 text-red-800',
    partial: 'bg-purple-100 text-purple-800',
  };
  return colors[status] || 'bg-gray-100 text-gray-800';
};

const getStatusLabel = (status: string): string => {
  const labels: Record<string, string> = {
    active: 'Aktiv',
    completed: 'Abgeschlossen',
    archived: 'Archiviert',
    on_hold: 'Pausiert',
    draft: 'üìù Entwurf',
    calculated: 'üî¢ Berechnet',
    submitted: 'üì§ Eingereicht',
    in_review: '‚è≥ In Pr√ºfung',
    approved: '‚úÖ Bewilligt',
    paid: 'üí∞ Ausgezahlt',
    rejected: '‚ùå Abgelehnt',
    partial: 'üìä Teilweise',
  };
  return labels[status] || status;
};

const getFundingProgramLabel = (program: string | null): string => {
  const labels: Record<string, string> = {
    ZIM: 'ZIM - Zentrales Innovationsprogramm Mittelstand',
    FZul: 'FZul - Forschungszulage',
    BAFA: 'BAFA - Bundesamt f√ºr Wirtschaft',
    other: 'Sonstiges F√∂rderprogramm',
  };
  return program ? labels[program] || program : '-';
};

// ============================================
// MAIN COMPONENT
// ============================================

export default function ProjectDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params);
  const projectId = resolvedParams.id;
  
  const router = useRouter();
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  // State
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  
  const [profile, setProfile] = useState<any>(null);
  const [project, setProject] = useState<Project | null>(null);
  const [workPackages, setWorkPackages] = useState<WorkPackage[]>([]);
  const [projectAssignments, setProjectAssignments] = useState<ProjectAssignment[]>([]);
  const [paymentRequests, setPaymentRequests] = useState<PaymentRequest[]>([]);
  const [companyEmployees, setCompanyEmployees] = useState<Employee[]>([]);
  
  // UI State
  const [activeTab, setActiveTab] = useState<'arbeitspakete' | 'mitarbeiter' | 'anlage62' | 'foerderung' | 'zahlungsanforderungen'>('arbeitspakete');
  const [isEditing, setIsEditing] = useState(false);
  const [editedProject, setEditedProject] = useState<Partial<Project>>({});
  
  // Modal States
  const [showAPModal, setShowAPModal] = useState(false);
  const [showZAModal, setShowZAModal] = useState(false);
  const [editingAP, setEditingAP] = useState<WorkPackage | null>(null);
  const [selectedZaId, setSelectedZaId] = useState<string | null>(null);
  
  // ZA Creation State
  const [zaFormData, setZaFormData] = useState({
    period_start: '',
    period_end: '',
  });
  const [zaCalculation, setZaCalculation] = useState<{
    items: PaymentRequestItem[];
    totals: {
      personnel_hours: number;
      personnel_costs: number;
      overhead_costs: number;
      total_eligible_costs: number;
      requested_amount: number;
    };
  } | null>(null);
  const [zaCalculating, setZaCalculating] = useState(false);

  // ============================================
  // DATA LOADING
  // ============================================

  useEffect(() => {
    loadData();
  }, [projectId]);

  const loadData = async () => {
    try {
      setLoading(true);
      setError('');

      // User & Profile
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        router.push('/login');
        return;
      }

      const { data: profileData } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (!profileData) {
        setError('Profil nicht gefunden');
        return;
      }
      setProfile(profileData);

      // Project
      const { data: projectData, error: projectError } = await supabase
        .from('projects')
        .select('*')
        .eq('id', projectId)
        .single();

      if (projectError || !projectData) {
        setError('Projekt nicht gefunden');
        return;
      }
      setProject(projectData);
      setEditedProject(projectData);

      // Work Packages with Assignments
      const { data: wpData } = await supabase
        .from('work_packages')
        .select(`
          *,
          work_package_assignments (
            *,
            user_profile:user_profiles (
              name,
              qualification_group
            )
          )
        `)
        .eq('project_id', projectId)
        .order('display_order');

      setWorkPackages(wpData || []);

      // Project Assignments
      const { data: paData } = await supabase
        .from('project_assignments')
        .select(`
          *,
          user_profile:user_profiles (
            id,
            name,
            qualification,
            qualification_group,
            weekly_hours_contract
          )
        `)
        .eq('project_id', projectId)
        .order('project_employee_number');

      setProjectAssignments(paData || []);

      // Payment Requests
      const { data: prData } = await supabase
        .from('payment_requests')
        .select('*')
        .eq('project_id', projectId)
        .order('request_number', { ascending: false });

      setPaymentRequests(prData || []);

      // All Company Employees (for assignment modals)
      const { data: empData } = await supabase
        .from('user_profiles')
        .select('id, name, qualification_group, weekly_hours_contract')
        .eq('company_id', profileData.company_id)
        .eq('is_active', true)
        .order('name');

      setCompanyEmployees(empData || []);

    } catch (err: any) {
      console.error('Load error:', err);
      setError(err.message || 'Fehler beim Laden');
    } finally {
      setLoading(false);
    }
  };

  // ============================================
  // PROJECT ACTIONS
  // ============================================

  const handleSaveProject = async () => {
    if (!project) return;
    setSaving(true);
    setError('');
    setSuccess('');

    try {
      const { error: updateError } = await supabase
        .from('projects')
        .update({
          name: editedProject.name,
          description: editedProject.description,
          project_number: editedProject.project_number,
          status: editedProject.status,
          start_date: editedProject.start_date,
          end_date: editedProject.end_date,
          budget: editedProject.budget,
          client_name: editedProject.client_name,
          client_contact: editedProject.client_contact,
          color: editedProject.color,
          // F√∂rderfelder
          funding_program: editedProject.funding_program,
          funding_reference: editedProject.funding_reference,
          funding_approval_date: editedProject.funding_approval_date,
          funding_amount: editedProject.funding_amount,
          funding_rate: editedProject.funding_rate,
          overhead_rate: editedProject.overhead_rate,
          funding_start_date: editedProject.funding_start_date,
          funding_end_date: editedProject.funding_end_date,
          project_manager: editedProject.project_manager,
          project_manager_phone: editedProject.project_manager_phone,
          project_manager_email: editedProject.project_manager_email,
          updated_at: new Date().toISOString(),
        })
        .eq('id', project.id);

      if (updateError) throw updateError;

      setSuccess('Projekt gespeichert');
      setIsEditing(false);
      loadData();
    } catch (err: any) {
      setError(err.message);
    } finally {
      setSaving(false);
    }
  };

  // ============================================
  // ZAHLUNGSANFORDERUNG ACTIONS
  // ============================================

  const handleCalculateZA = async () => {
    if (!zaFormData.period_start || !zaFormData.period_end || !project) {
      setError('Bitte Start- und Enddatum angeben');
      return;
    }

    setZaCalculating(true);
    setError('');

    try {
      // Get time entries for period
      const { data: timeEntries, error: teError } = await supabase
        .from('time_entries')
        .select(`
          *,
          user_profile:user_profiles (
            id,
            name,
            qualification_group
          )
        `)
        .eq('project_id', project.id)
        .eq('category', 'project_work')
        .gte('entry_date', zaFormData.period_start)
        .lte('entry_date', zaFormData.period_end);

      if (teError) throw teError;

      // Group by employee and month
      const employeeData: Record<string, {
        user_profile_id: string;
        name: string;
        qualification_group: string;
        hours_by_month: Record<string, number>;
        total_hours: number;
      }> = {};

      (timeEntries || []).forEach((entry: any) => {
        const upId = entry.user_profile_id;
        const monthKey = entry.entry_date.substring(0, 7); // YYYY-MM

        if (!employeeData[upId]) {
          employeeData[upId] = {
            user_profile_id: upId,
            name: entry.user_profile?.name || 'Unbekannt',
            qualification_group: entry.user_profile?.qualification_group || 'C',
            hours_by_month: {},
            total_hours: 0,
          };
        }

        if (!employeeData[upId].hours_by_month[monthKey]) {
          employeeData[upId].hours_by_month[monthKey] = 0;
        }

        employeeData[upId].hours_by_month[monthKey] += Number(entry.hours);
        employeeData[upId].total_hours += Number(entry.hours);
      });

      // Get salary data for hourly rates
      const year = new Date(zaFormData.period_start).getFullYear();
      const userIds = Object.keys(employeeData);

      const { data: salaryData } = await supabase
        .from('salary_components')
        .select('user_profile_id, hourly_rate')
        .in('user_profile_id', userIds)
        .eq('year', year);

      const salaryMap: Record<string, number> = {};
      (salaryData || []).forEach((s: any) => {
        salaryMap[s.user_profile_id] = Number(s.hourly_rate) || 50; // Default 50‚Ç¨/h
      });

      // Get project assignment numbers - NUR diese MA sind f√ºr ZA berechtigt!
      const assignmentMap: Record<string, number> = {};
      const assignedUserIds = new Set<string>();
      projectAssignments.forEach(pa => {
        assignmentMap[pa.user_profile_id] = pa.project_employee_number;
        assignedUserIds.add(pa.user_profile_id);
      });

      // Build items - NUR f√ºr MA die dem Projekt zugeordnet sind
      const items: PaymentRequestItem[] = Object.values(employeeData)
        .filter(emp => assignedUserIds.has(emp.user_profile_id)) // ‚Üê NUR zugeordnete MA!
        .map(emp => ({
          user_profile_id: emp.user_profile_id,
          employee_number: assignmentMap[emp.user_profile_id] || 0,
          employee_name: emp.name,
          qualification_group: emp.qualification_group,
          hours_by_month: emp.hours_by_month,
          total_hours: emp.total_hours,
          hourly_rate: salaryMap[emp.user_profile_id] || 50,
          total_costs: emp.total_hours * (salaryMap[emp.user_profile_id] || 50),
        }));

      // Calculate totals
      const personnel_hours = items.reduce((sum, i) => sum + i.total_hours, 0);
      const personnel_costs = items.reduce((sum, i) => sum + i.total_costs, 0);
      const overhead_rate = project.overhead_rate || 0;
      const overhead_costs = personnel_costs * (overhead_rate / 100);
      const total_eligible_costs = personnel_costs + overhead_costs;
      const funding_rate = project.funding_rate || 50;
      const requested_amount = total_eligible_costs * (funding_rate / 100);

      setZaCalculation({
        items: items.sort((a, b) => a.employee_number - b.employee_number),
        totals: {
          personnel_hours,
          personnel_costs,
          overhead_costs,
          total_eligible_costs,
          requested_amount,
        },
      });

    } catch (err: any) {
      setError(err.message);
    } finally {
      setZaCalculating(false);
    }
  };

  const handleSaveZA = async (asDraft: boolean = true) => {
    if (!zaCalculation || !project) return;

    setSaving(true);
    setError('');

    try {
      // Get next ZA number
      const { data: nextNumData } = await supabase
        .rpc('get_next_za_number', { p_project_id: project.id });
      
      const requestNumber = nextNumData || 1;

      // Create payment request
      const { data: newPR, error: prError } = await supabase
        .from('payment_requests')
        .insert([{
          company_id: project.company_id,
          project_id: project.id,
          request_number: requestNumber,
          period_start: zaFormData.period_start,
          period_end: zaFormData.period_end,
          personnel_costs: zaCalculation.totals.personnel_costs,
          personnel_hours: zaCalculation.totals.personnel_hours,
          overhead_costs: zaCalculation.totals.overhead_costs,
          total_eligible_costs: zaCalculation.totals.total_eligible_costs,
          funding_rate_applied: project.funding_rate || 50,
          requested_amount: zaCalculation.totals.requested_amount,
          status: asDraft ? 'draft' : 'calculated',
          calculated_at: new Date().toISOString(),
        }])
        .select()
        .single();

      if (prError) throw prError;

      // Create items
      const itemsToInsert = zaCalculation.items.map(item => ({
        payment_request_id: newPR.id,
        user_profile_id: item.user_profile_id,
        employee_number: item.employee_number,
        employee_name: item.employee_name,
        qualification_group: item.qualification_group,
        hours_by_month: item.hours_by_month,
        total_hours: item.total_hours,
        hourly_rate: item.hourly_rate,
        total_costs: item.total_costs,
      }));

      const { error: itemsError } = await supabase
        .from('payment_request_items')
        .insert(itemsToInsert);

      if (itemsError) throw itemsError;

      setSuccess(`Zahlungsanforderung Nr. ${requestNumber} erstellt`);
      setShowZAModal(false);
      setZaFormData({ period_start: '', period_end: '' });
      setZaCalculation(null);
      loadData();

    } catch (err: any) {
      setError(err.message);
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteZA = async (zaId: string) => {
    if (!confirm('Zahlungsanforderung wirklich l√∂schen?')) return;

    try {
      const { error } = await supabase
        .from('payment_requests')
        .delete()
        .eq('id', zaId);

      if (error) throw error;
      setSuccess('Zahlungsanforderung gel√∂scht');
      loadData();
    } catch (err: any) {
      setError(err.message);
    }
  };

  // ============================================
  // COMPUTED VALUES
  // ============================================

  const isAdmin = profile?.role === 'company_admin';
  const isManager = profile?.role === 'manager';
  const canEdit = isAdmin || isManager;

  // Funding status calculation
  const fundingStatus = {
    approved: project?.funding_amount || 0,
    requested: paymentRequests
      .filter(pr => ['submitted', 'in_review', 'approved', 'paid', 'partial'].includes(pr.status))
      .reduce((sum, pr) => sum + (pr.requested_amount || 0), 0),
    paid: paymentRequests
      .filter(pr => ['paid', 'partial'].includes(pr.status))
      .reduce((sum, pr) => sum + (pr.paid_amount || 0), 0),
    pending: paymentRequests
      .filter(pr => ['submitted', 'in_review'].includes(pr.status))
      .reduce((sum, pr) => sum + (pr.requested_amount || 0), 0),
    available: 0,
  };
  fundingStatus.available = fundingStatus.approved - fundingStatus.paid - fundingStatus.pending;

  // ============================================
  // RENDER
  // ============================================

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Projekt wird geladen...</p>
        </div>
      </div>
    );
  }

  if (!project) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600 mb-4">Projekt nicht gefunden</p>
          <button
            onClick={() => router.push('/projekte')}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg"
          >
            Zur√ºck zur √úbersicht
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Navigation */}
      <nav className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <button
                onClick={() => router.push('/projekte')}
                className="flex items-center text-gray-600 hover:text-gray-900"
              >
                <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
                <span className="font-medium">Zur√ºck zu Projekte</span>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        {/* Messages */}
        {error && (
          <div className="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
            {error}
          </div>
        )}
        {success && (
          <div className="mb-6 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">
            {success}
          </div>
        )}

        {/* Project Header */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <div className="flex items-start justify-between">
            <div className="flex items-center">
              <div 
                className="w-4 h-16 rounded-l-lg mr-4"
                style={{ backgroundColor: project.color || '#3B82F6' }}
              />
              <div>
                <h1 className="text-2xl font-bold text-gray-900">{project.name}</h1>
                <div className="flex items-center mt-2 space-x-4">
                  {project.project_number && (
                    <span className="text-sm text-gray-500">#{project.project_number}</span>
                  )}
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(project.status)}`}>
                    {getStatusLabel(project.status)}
                  </span>
                  {project.funding_reference && (
                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                      üìã {project.funding_reference}
                    </span>
                  )}
                </div>
              </div>
            </div>
            {canEdit && !isEditing && (
              <button
                onClick={() => setIsEditing(true)}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
              >
                Bearbeiten
              </button>
            )}
          </div>
        </div>

        {/* Tabs */}
        <div className="bg-white rounded-lg shadow-md mb-6">
          <div className="border-b border-gray-200">
            <nav className="flex -mb-px overflow-x-auto">
              {[
                { key: 'arbeitspakete', label: 'üì¶ Arbeitspakete', count: workPackages.length },
                { key: 'mitarbeiter', label: 'üë• Projektmitarbeiter', count: projectAssignments.length },
                { key: 'anlage62', label: 'üìä Anlage 6.2' },
                { key: 'foerderung', label: 'üí∞ F√∂rderung' },
                { key: 'zahlungsanforderungen', label: 'üìÑ Zahlungsanforderungen', count: paymentRequests.length },
              ].map((tab) => (
                <button
                  key={tab.key}
                  onClick={() => setActiveTab(tab.key as any)}
                  className={`whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm ${
                    activeTab === tab.key
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  {tab.label}
                  {tab.count !== undefined && (
                    <span className="ml-2 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs">
                      {tab.count}
                    </span>
                  )}
                </button>
              ))}
            </nav>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {/* ========== TAB: ARBEITSPAKETE ========== */}
            {activeTab === 'arbeitspakete' && (
              <div>
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-lg font-semibold">Arbeitspakete</h2>
                  {canEdit && (
                    <button
                      onClick={() => { setEditingAP(null); setShowAPModal(true); }}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center"
                    >
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                      Neues Arbeitspaket
                    </button>
                  )}
                </div>

                {workPackages.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <p>Noch keine Arbeitspakete angelegt</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Beschreibung</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategorie</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zeitraum</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zuordnungen</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {workPackages.map((wp) => (
                          <tr key={wp.id} className="hover:bg-gray-50">
                            <td className="px-4 py-3 font-medium text-gray-900">{wp.code}</td>
                            <td className="px-4 py-3 text-gray-600">{wp.description}</td>
                            <td className="px-4 py-3">
                              <span className={`px-2 py-1 rounded text-xs ${
                                wp.category === 'fundable' 
                                  ? 'bg-green-100 text-green-800' 
                                  : 'bg-gray-100 text-gray-800'
                              }`}>
                                {wp.category === 'fundable' ? 'F√∂rderf√§hig' : 'Nicht f√∂rderf√§hig'}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-500">
                              {wp.start_date && wp.end_date 
                                ? `${formatDate(wp.start_date)} - ${formatDate(wp.end_date)}`
                                : '-'}
                            </td>
                            <td className="px-4 py-3">
                              {wp.assignments && wp.assignments.length > 0 ? (
                                <div className="flex flex-wrap gap-1">
                                  {wp.assignments.slice(0, 3).map((a, i) => (
                                    <span key={i} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">
                                      {a.user_profile?.name?.split(' ')[0]} ({a.person_months} PM)
                                    </span>
                                  ))}
                                  {wp.assignments.length > 3 && (
                                    <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">
                                      +{wp.assignments.length - 3}
                                    </span>
                                  )}
                                </div>
                              ) : (
                                <span className="text-gray-400 text-sm">-</span>
                              )}
                            </td>
                            <td className="px-4 py-3 text-right">
                              {canEdit && (
                                <button
                                  onClick={() => { setEditingAP(wp); setShowAPModal(true); }}
                                  className="text-blue-600 hover:text-blue-800"
                                >
                                  Bearbeiten
                                </button>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}

            {/* ========== TAB: PROJEKTMITARBEITER ========== */}
            {activeTab === 'mitarbeiter' && (
              <div>
                <h2 className="text-lg font-semibold mb-6">Projektmitarbeiter</h2>
                
                {projectAssignments.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <p>Noch keine Mitarbeiter zugeordnet</p>
                    <p className="text-sm mt-2">Ordnen Sie Mitarbeiter √ºber die Arbeitspakete zu</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MA-Nr.</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qualifikation</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gruppe</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Wochenstunden</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {projectAssignments.map((pa) => (
                          <tr key={pa.id} className="hover:bg-gray-50">
                            <td className="px-4 py-3 font-medium text-gray-900">
                              {pa.project_employee_number || '-'}
                            </td>
                            <td className="px-4 py-3 text-gray-900">{pa.user_profile?.name}</td>
                            <td className="px-4 py-3 text-gray-600">{pa.user_profile?.qualification || '-'}</td>
                            <td className="px-4 py-3">
                              <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">
                                {pa.user_profile?.qualification_group || '-'}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-right text-gray-600">
                              {pa.user_profile?.weekly_hours_contract || 40}h
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}

            {/* ========== TAB: ANLAGE 6.2 ========== */}
            {activeTab === 'anlage62' && (
              <div>
                <h2 className="text-lg font-semibold mb-6">Anlage 6.2 - Planung der Personalkapazit√§t</h2>
                <p className="text-gray-500 mb-4">
                  √úbersicht der geplanten Personenmonate pro Mitarbeiter und Jahr.
                </p>
                {/* Placeholder - existing implementation */}
                <div className="text-center py-12 text-gray-400">
                  <p>Anlage 6.2 Darstellung</p>
                  <p className="text-sm">(Bestehende Implementierung)</p>
                </div>
              </div>
            )}

            {/* ========== TAB: F√ñRDERUNG ========== */}
            {activeTab === 'foerderung' && (
              <div>
                <h2 className="text-lg font-semibold mb-6">F√∂rdermittel-Einstellungen</h2>
                
                {isEditing ? (
                  // Edit Mode
                  <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {/* F√∂rderprogramm */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          F√∂rderprogramm
                        </label>
                        <select
                          value={editedProject.funding_program || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_program: e.target.value || null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="">-- Kein F√∂rderprogramm --</option>
                          <option value="ZIM">ZIM - Zentrales Innovationsprogramm Mittelstand</option>
                          <option value="FZul">FZul - Forschungszulage</option>
                          <option value="BAFA">BAFA - Bundesamt f√ºr Wirtschaft</option>
                          <option value="other">Sonstiges</option>
                        </select>
                      </div>

                      {/* F√∂rderkennzeichen */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          F√∂rderkennzeichen
                        </label>
                        <input
                          type="text"
                          value={editedProject.funding_reference || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_reference: e.target.value || null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="z.B. 16KN123456"
                        />
                      </div>

                      {/* Bewilligte F√∂rdersumme */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Bewilligte F√∂rdersumme (‚Ç¨)
                        </label>
                        <input
                          type="number"
                          value={editedProject.funding_amount || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_amount: e.target.value ? Number(e.target.value) : null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="z.B. 200000"
                          step="0.01"
                        />
                      </div>

                      {/* F√∂rdersatz */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          F√∂rdersatz (%)
                        </label>
                        <input
                          type="number"
                          value={editedProject.funding_rate || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_rate: e.target.value ? Number(e.target.value) : null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="z.B. 50"
                          min="0"
                          max="100"
                          step="0.1"
                        />
                      </div>

                      {/* Gemeinkostenpauschale */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Gemeinkostenpauschale (%)
                        </label>
                        <input
                          type="number"
                          value={editedProject.overhead_rate || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, overhead_rate: e.target.value ? Number(e.target.value) : null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="z.B. 100"
                          min="0"
                          step="0.1"
                        />
                      </div>

                      {/* Zuwendungsbescheid Datum */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Zuwendungsbescheid vom
                        </label>
                        <input
                          type="date"
                          value={editedProject.funding_approval_date || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_approval_date: e.target.value || null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      {/* Bewilligungszeitraum Start */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Bewilligungszeitraum von
                        </label>
                        <input
                          type="date"
                          value={editedProject.funding_start_date || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_start_date: e.target.value || null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      {/* Bewilligungszeitraum Ende */}
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Bewilligungszeitraum bis
                        </label>
                        <input
                          type="date"
                          value={editedProject.funding_end_date || ''}
                          onChange={(e) => setEditedProject({ ...editedProject, funding_end_date: e.target.value || null })}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </div>

                    {/* Projektleiter */}
                    <div className="border-t pt-6">
                      <h3 className="text-md font-medium text-gray-900 mb-4">Projektleiter / Ansprechpartner</h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Name</label>
                          <input
                            type="text"
                            value={editedProject.project_manager || ''}
                            onChange={(e) => setEditedProject({ ...editedProject, project_manager: e.target.value || null })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                          <input
                            type="tel"
                            value={editedProject.project_manager_phone || ''}
                            onChange={(e) => setEditedProject({ ...editedProject, project_manager_phone: e.target.value || null })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                          <input
                            type="email"
                            value={editedProject.project_manager_email || ''}
                            onChange={(e) => setEditedProject({ ...editedProject, project_manager_email: e.target.value || null })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                      </div>
                    </div>

                    {/* NEU: J√§hrliche Zuwendungsplanung */}
                    <div className="border-t pt-6">
                      <h3 className="text-md font-medium text-gray-900 mb-4">üìÖ J√§hrliche Zuwendungsplanung (Haushaltsjahre)</h3>
                      <p className="text-sm text-gray-500 mb-4">
                        Tragen Sie hier die geplanten Zuwendungen pro Haushaltsjahr aus dem Zuwendungsbescheid ein.
                      </p>
                      <div className="space-y-3">
                        {(() => {
                          const startYear = editedProject.funding_start_date ? new Date(editedProject.funding_start_date).getFullYear() : new Date().getFullYear();
                          const endYear = editedProject.funding_end_date ? new Date(editedProject.funding_end_date).getFullYear() : startYear + 2;
                          const years = [];
                          for (let y = startYear; y <= endYear; y++) years.push(y);
                          return years.map(year => (
                            <div key={year} className="flex items-center gap-4">
                              <label className="w-24 text-sm font-medium text-gray-700">{year}</label>
                              <div className="relative flex-1 max-w-xs">
                                <input
                                  type="number"
                                  value={(editedProject.funding_yearly_budget as any)?.[year] || ''}
                                  onChange={(e) => {
                                    const newBudget = { ...(editedProject.funding_yearly_budget || {}) };
                                    if (e.target.value) {
                                      (newBudget as any)[year] = Number(e.target.value);
                                    } else {
                                      delete (newBudget as any)[year];
                                    }
                                    setEditedProject({ ...editedProject, funding_yearly_budget: newBudget });
                                  }}
                                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="0"
                                  step="0.01"
                                />
                                <span className="absolute right-3 top-2 text-gray-400">‚Ç¨</span>
                              </div>
                            </div>
                          ));
                        })()}
                      </div>
                    </div>

                    {/* NEU: Gesamtvorkalkulation (Kostenplan) */}
                    <div className="border-t pt-6">
                      <h3 className="text-md font-medium text-gray-900 mb-4">üìä Gesamtvorkalkulation (aus Zuwendungsbescheid)</h3>
                      <p className="text-sm text-gray-500 mb-4">
                        √úbertragen Sie die Kostenplanung aus der Anlage "Hinweise und Auflagen" (Abschnitt 1.2) des Zuwendungsbescheids.
                      </p>
                      
                      {/* Tabelle wie im Zuwendungsbescheid */}
                      <div className="overflow-x-auto border rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Position</th>
                              <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">zuwendungsf√§hige Kosten (‚Ç¨)</th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {/* 1. Personalkosten */}
                            <tr>
                              <td className="px-4 py-3 text-sm">
                                <span className="font-medium">1.</span> Personalkosten gem√§√ü Nr. 5.3.1 Buchstabe a) der Richtlinie ZIM
                              </td>
                              <td className="px-4 py-3">
                                <input
                                  type="number"
                                  value={(editedProject.cost_plan as any)?.personnel_costs_planned || ''}
                                  onChange={(e) => setEditedProject({
                                    ...editedProject,
                                    cost_plan: { ...(editedProject.cost_plan || {}), personnel_costs_planned: e.target.value ? Number(e.target.value) : 0 } as any
                                  })}
                                  className="w-full px-3 py-1.5 border border-gray-300 rounded text-right focus:ring-2 focus:ring-blue-500"
                                  step="0.01"
                                  placeholder="0,00"
                                />
                              </td>
                            </tr>
                            {/* 2. √úbrige Kosten */}
                            <tr>
                              <td className="px-4 py-3 text-sm">
                                <span className="font-medium">2.</span> √úbrige Kosten gem√§√ü Nr. 5.3.1 Buchstabe c) der Richtlinie ZIM
                              </td>
                              <td className="px-4 py-3">
                                <input
                                  type="number"
                                  value={(editedProject.cost_plan as any)?.overhead_costs_planned || ''}
                                  onChange={(e) => setEditedProject({
                                    ...editedProject,
                                    cost_plan: { ...(editedProject.cost_plan || {}), overhead_costs_planned: e.target.value ? Number(e.target.value) : 0 } as any
                                  })}
                                  className="w-full px-3 py-1.5 border border-gray-300 rounded text-right focus:ring-2 focus:ring-blue-500"
                                  step="0.01"
                                  placeholder="0,00"
                                />
                              </td>
                            </tr>
                            {/* 3. Projektbezogene Auftr√§ge an Dritte */}
                            <tr>
                              <td className="px-4 py-3 text-sm">
                                <span className="font-medium">3.</span> Kosten f√ºr projektbezogene Auftr√§ge an Dritte gem√§√ü Nr. 5.3.1 Buchstabe b) der Richtlinie ZIM
                              </td>
                              <td className="px-4 py-3">
                                <input
                                  type="number"
                                  value={(editedProject.cost_plan as any)?.third_party_costs_planned || ''}
                                  onChange={(e) => setEditedProject({
                                    ...editedProject,
                                    cost_plan: { ...(editedProject.cost_plan || {}), third_party_costs_planned: e.target.value ? Number(e.target.value) : 0 } as any
                                  })}
                                  className="w-full px-3 py-1.5 border border-gray-300 rounded text-right focus:ring-2 focus:ring-blue-500"
                                  step="0.01"
                                  placeholder="0,00"
                                />
                              </td>
                            </tr>
                            {/* 4. FuE-Auftr√§ge */}
                            <tr>
                              <td className="px-4 py-3 text-sm">
                                <span className="font-medium">4.</span> Kosten f√ºr FuE-Auftr√§ge gem√§√ü Nr. 5.3.1 Buchstabe b) der Richtlinie ZIM
                              </td>
                              <td className="px-4 py-3">
                                <input
                                  type="number"
                                  value={(editedProject.cost_plan as any)?.fue_contracts_planned || ''}
                                  onChange={(e) => setEditedProject({
                                    ...editedProject,
                                    cost_plan: { ...(editedProject.cost_plan || {}), fue_contracts_planned: e.target.value ? Number(e.target.value) : 0 } as any
                                  })}
                                  className="w-full px-3 py-1.5 border border-gray-300 rounded text-right focus:ring-2 focus:ring-blue-500"
                                  step="0.01"
                                  placeholder="0,00"
                                />
                              </td>
                            </tr>
                            {/* 5. Zeitweilige Aufnahmen */}
                            <tr>
                              <td className="px-4 py-3 text-sm">
                                <span className="font-medium">5.</span> Kosten f√ºr zeitweilige Aufnahmen qualifizierten Personals gem√§√ü Nr. 5.3.1 Buchstabe b) der Richtlinie ZIM
                              </td>
                              <td className="px-4 py-3">
                                <input
                                  type="number"
                                  value={(editedProject.cost_plan as any)?.temp_personnel_planned || ''}
                                  onChange={(e) => setEditedProject({
                                    ...editedProject,
                                    cost_plan: { ...(editedProject.cost_plan || {}), temp_personnel_planned: e.target.value ? Number(e.target.value) : 0 } as any
                                  })}
                                  className="w-full px-3 py-1.5 border border-gray-300 rounded text-right focus:ring-2 focus:ring-blue-500"
                                  step="0.01"
                                  placeholder="0,00"
                                />
                              </td>
                            </tr>
                          </tbody>
                          <tfoot className="bg-gray-100">
                            {/* 6. Summe projektbezogene Kosten */}
                            <tr>
                              <td className="px-4 py-3 text-sm font-medium">
                                <span className="font-medium">6.</span> Summe der projektbezogenen Kosten
                              </td>
                              <td className="px-4 py-3 text-right font-bold">
                                {formatCurrency(
                                  ((editedProject.cost_plan as any)?.personnel_costs_planned || 0) +
                                  ((editedProject.cost_plan as any)?.overhead_costs_planned || 0) +
                                  ((editedProject.cost_plan as any)?.third_party_costs_planned || 0) +
                                  ((editedProject.cost_plan as any)?.fue_contracts_planned || 0) +
                                  ((editedProject.cost_plan as any)?.temp_personnel_planned || 0)
                                )}
                              </td>
                            </tr>
                            {/* Summe Zuwendung */}
                            <tr className="bg-green-50">
                              <td className="px-4 py-3 text-sm font-bold text-green-800">
                                Summe Zuwendung
                              </td>
                              <td className="px-4 py-3 text-right font-bold text-green-800">
                                {formatCurrency(editedProject.funding_amount || 0)}
                              </td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                      
                      <p className="text-xs text-gray-500 mt-2">
                        Die Summe Zuwendung wird aus dem Feld "Bewilligte F√∂rdersumme" √ºbernommen.
                      </p>
                    </div>

                    {/* Actions */}
                    <div className="flex justify-end space-x-4 pt-4 border-t">
                      <button
                        onClick={() => { setIsEditing(false); setEditedProject(project); }}
                        className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                      >
                        Abbrechen
                      </button>
                      <button
                        onClick={handleSaveProject}
                        disabled={saving}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400"
                      >
                        {saving ? 'Speichern...' : 'Speichern'}
                      </button>
                    </div>
                  </div>
                ) : (
                  // View Mode
                  <div className="space-y-6">
                    {/* Status Cards */}
                    {project.funding_amount && (
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div className="bg-blue-50 rounded-lg p-4">
                          <div className="text-sm text-blue-600 font-medium">Bewilligt</div>
                          <div className="text-xl font-bold text-blue-900">{formatCurrency(fundingStatus.approved)}</div>
                        </div>
                        <div className="bg-green-50 rounded-lg p-4">
                          <div className="text-sm text-green-600 font-medium">Ausgezahlt</div>
                          <div className="text-xl font-bold text-green-900">{formatCurrency(fundingStatus.paid)}</div>
                        </div>
                        <div className="bg-yellow-50 rounded-lg p-4">
                          <div className="text-sm text-yellow-600 font-medium">In Pr√ºfung</div>
                          <div className="text-xl font-bold text-yellow-900">{formatCurrency(fundingStatus.pending)}</div>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-4">
                          <div className="text-sm text-gray-600 font-medium">Verf√ºgbar</div>
                          <div className="text-xl font-bold text-gray-900">{formatCurrency(fundingStatus.available)}</div>
                        </div>
                      </div>
                    )}

                    {/* Details Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">F√∂rderprogramm</div>
                        <div className="font-medium">{getFundingProgramLabel(project.funding_program)}</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">F√∂rderkennzeichen</div>
                        <div className="font-medium">{project.funding_reference || '-'}</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">Bewilligte F√∂rdersumme</div>
                        <div className="font-medium">{formatCurrency(project.funding_amount)}</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">F√∂rdersatz</div>
                        <div className="font-medium">{project.funding_rate ? `${project.funding_rate}%` : '-'}</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">Gemeinkostenpauschale</div>
                        <div className="font-medium">{project.overhead_rate ? `${project.overhead_rate}%` : '-'}</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">Zuwendungsbescheid vom</div>
                        <div className="font-medium">{formatDate(project.funding_approval_date)}</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-500">Bewilligungszeitraum</div>
                        <div className="font-medium">
                          {project.funding_start_date && project.funding_end_date
                            ? `${formatDate(project.funding_start_date)} - ${formatDate(project.funding_end_date)}`
                            : '-'}
                        </div>
                      </div>
                    </div>

                    {/* Project Manager */}
                    {project.project_manager && (
                      <div className="border-t pt-6 mt-6">
                        <h3 className="text-md font-medium text-gray-900 mb-4">Projektleiter</h3>
                        <div className="bg-gray-50 rounded-lg p-4">
                          <div className="font-medium">{project.project_manager}</div>
                          {project.project_manager_phone && (
                            <div className="text-sm text-gray-600 mt-1">üìû {project.project_manager_phone}</div>
                          )}
                          {project.project_manager_email && (
                            <div className="text-sm text-gray-600">‚úâÔ∏è {project.project_manager_email}</div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* NEU: J√§hrliche Zuwendungsplanung */}
                    {project.funding_yearly_budget && Object.keys(project.funding_yearly_budget).length > 0 && (
                      <div className="border-t pt-6 mt-6">
                        <h3 className="text-md font-medium text-gray-900 mb-4">üìÖ J√§hrliche Zuwendungsplanung</h3>
                        <div className="overflow-x-auto">
                          <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jahr</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Geplant</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Angefordert</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ausgezahlt</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Differenz</th>
                                <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                              </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                              {Object.entries(project.funding_yearly_budget)
                                .sort(([a], [b]) => Number(a) - Number(b))
                                .map(([year, planned]) => {
                                  // Berechne Ist-Werte pro Jahr aus paymentRequests
                                  const yearPRs = paymentRequests.filter(pr => {
                                    const prYear = new Date(pr.period_start).getFullYear();
                                    return prYear === Number(year) && pr.status !== 'draft' && pr.status !== 'rejected';
                                  });
                                  const requested = yearPRs.reduce((sum, pr) => sum + (pr.requested_amount || 0), 0);
                                  const paid = yearPRs.filter(pr => pr.status === 'paid').reduce((sum, pr) => sum + (pr.paid_amount || 0), 0);
                                  const diff = (planned as number) - requested;
                                  const isOver = requested > (planned as number);
                                  const isNear = requested > (planned as number) * 0.9;
                                  
                                  return (
                                    <tr key={year} className="hover:bg-gray-50">
                                      <td className="px-4 py-2 font-medium">{year}</td>
                                      <td className="px-4 py-2 text-right">{formatCurrency(planned as number)}</td>
                                      <td className="px-4 py-2 text-right">{formatCurrency(requested)}</td>
                                      <td className="px-4 py-2 text-right text-green-600">{formatCurrency(paid)}</td>
                                      <td className={`px-4 py-2 text-right font-medium ${isOver ? 'text-red-600' : 'text-gray-600'}`}>
                                        {isOver ? '-' : '+'}{formatCurrency(Math.abs(diff))}
                                      </td>
                                      <td className="px-4 py-2 text-center">
                                        {isOver ? (
                                          <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">‚ö†Ô∏è √úberschritten</span>
                                        ) : isNear ? (
                                          <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">‚ö° Fast erreicht</span>
                                        ) : (
                                          <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">‚úì OK</span>
                                        )}
                                      </td>
                                    </tr>
                                  );
                                })}
                            </tbody>
                            <tfoot className="bg-gray-100">
                              <tr>
                                <td className="px-4 py-2 font-medium">Gesamt</td>
                                <td className="px-4 py-2 text-right font-medium">
                                  {formatCurrency(Object.values(project.funding_yearly_budget).reduce((sum, v) => sum + (v as number), 0))}
                                </td>
                                <td className="px-4 py-2 text-right font-medium">
                                  {formatCurrency(paymentRequests.filter(pr => pr.status !== 'draft' && pr.status !== 'rejected').reduce((sum, pr) => sum + (pr.requested_amount || 0), 0))}
                                </td>
                                <td className="px-4 py-2 text-right font-medium text-green-600">
                                  {formatCurrency(paymentRequests.filter(pr => pr.status === 'paid').reduce((sum, pr) => sum + (pr.paid_amount || 0), 0))}
                                </td>
                                <td colSpan={2}></td>
                              </tr>
                            </tfoot>
                          </table>
                        </div>
                      </div>
                    )}

                    {/* NEU: Gesamtvorkalkulation */}
                    {project.cost_plan && (project.cost_plan as any).personnel_costs_planned > 0 && (
                      <div className="border-t pt-6 mt-6">
                        <h3 className="text-md font-medium text-gray-900 mb-4">üìä Gesamtvorkalkulation (Soll vs. Ist)</h3>
                        <div className="overflow-x-auto">
                          <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Position</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Geplant (Soll)</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Abgerechnet (Ist)</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Differenz</th>
                                <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                              </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                              {(() => {
                                const plan = project.cost_plan as any;
                                const activePRs = paymentRequests.filter(pr => pr.status !== 'draft' && pr.status !== 'rejected');
                                const actualPersonnel = activePRs.reduce((sum, pr) => sum + (pr.personnel_costs || 0), 0);
                                const actualOverhead = activePRs.reduce((sum, pr) => sum + (pr.overhead_costs || 0), 0);
                                const actualThirdParty = activePRs.reduce((sum, pr) => sum + (pr.third_party_costs || 0), 0);
                                // FuE-Auftr√§ge und Temp-Personal werden aktuell nicht separat in ZAs erfasst
                                // K√∂nnten sp√§ter √ºber third_party_costs oder eigene Felder abgebildet werden
                                
                                const rows = [
                                  { label: '1. Personalkosten (Nr. 5.3.1 a)', planned: plan.personnel_costs_planned || 0, actual: actualPersonnel },
                                  { label: '2. √úbrige Kosten (Nr. 5.3.1 c)', planned: plan.overhead_costs_planned || 0, actual: actualOverhead },
                                  { label: '3. Projektbezogene Auftr√§ge an Dritte (Nr. 5.3.1 b)', planned: plan.third_party_costs_planned || 0, actual: actualThirdParty },
                                  { label: '4. FuE-Auftr√§ge (Nr. 5.3.1 b)', planned: plan.fue_contracts_planned || 0, actual: 0, note: 'Wird separat erfasst' },
                                  { label: '5. Zeitweilige Aufnahmen (Nr. 5.3.1 b)', planned: plan.temp_personnel_planned || 0, actual: 0, note: 'Wird separat erfasst' },
                                ];
                                
                                return rows.map((row, idx) => {
                                  const diff = row.planned - row.actual;
                                  const isOver = row.actual > row.planned && row.planned > 0;
                                  const showStatus = row.planned > 0;
                                  return (
                                    <tr key={idx} className="hover:bg-gray-50">
                                      <td className="px-4 py-2 text-sm">{row.label}</td>
                                      <td className="px-4 py-2 text-right">{formatCurrency(row.planned)}</td>
                                      <td className="px-4 py-2 text-right">
                                        {(row as any).note ? (
                                          <span className="text-gray-400 text-xs italic">{(row as any).note}</span>
                                        ) : (
                                          formatCurrency(row.actual)
                                        )}
                                      </td>
                                      <td className={`px-4 py-2 text-right font-medium ${isOver ? 'text-red-600' : 'text-gray-600'}`}>
                                        {showStatus && !((row as any).note) ? (
                                          <>{isOver ? '-' : '+'}{formatCurrency(Math.abs(diff))}</>
                                        ) : '-'}
                                      </td>
                                      <td className="px-4 py-2 text-center">
                                        {showStatus && !((row as any).note) ? (
                                          isOver ? (
                                            <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">‚ö†Ô∏è √úber</span>
                                          ) : row.actual > row.planned * 0.9 ? (
                                            <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">‚ö° ~90%</span>
                                          ) : (
                                            <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">‚úì</span>
                                          )
                                        ) : null}
                                      </td>
                                    </tr>
                                  );
                                });
                              })()}
                            </tbody>
                            <tfoot className="bg-gray-100">
                              {(() => {
                                const plan = project.cost_plan as any;
                                const activePRs = paymentRequests.filter(pr => pr.status !== 'draft' && pr.status !== 'rejected');
                                const plannedTotal = (plan.personnel_costs_planned || 0) + (plan.overhead_costs_planned || 0) + 
                                  (plan.third_party_costs_planned || 0) + (plan.fue_contracts_planned || 0) + (plan.temp_personnel_planned || 0);
                                const actualTotal = activePRs.reduce((sum, pr) => sum + (pr.total_eligible_costs || 0), 0);
                                const diff = plannedTotal - actualTotal;
                                const isOver = actualTotal > plannedTotal;
                                
                                return (
                                  <>
                                    <tr>
                                      <td className="px-4 py-2 font-medium">6. Summe projektbezogene Kosten</td>
                                      <td className="px-4 py-2 text-right font-medium">{formatCurrency(plannedTotal)}</td>
                                      <td className="px-4 py-2 text-right font-medium">{formatCurrency(actualTotal)}</td>
                                      <td className={`px-4 py-2 text-right font-bold ${isOver ? 'text-red-600' : 'text-green-600'}`}>
                                        {isOver ? '-' : '+'}{formatCurrency(Math.abs(diff))}
                                      </td>
                                      <td className="px-4 py-2 text-center">
                                        {isOver && <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">‚ö†Ô∏è √úberschritten</span>}
                                      </td>
                                    </tr>
                                    <tr className="bg-green-50">
                                      <td className="px-4 py-2 font-bold text-green-800">Summe Zuwendung</td>
                                      <td className="px-4 py-2 text-right font-bold text-green-800">{formatCurrency(project.funding_amount || 0)}</td>
                                      <td className="px-4 py-2 text-right font-bold text-green-700">
                                        {formatCurrency(activePRs.filter(pr => pr.status === 'paid').reduce((sum, pr) => sum + (pr.paid_amount || 0), 0))}
                                      </td>
                                      <td colSpan={2} className="px-4 py-2 text-right text-xs text-green-600">
                                        ausgezahlt
                                      </td>
                                    </tr>
                                  </>
                                );
                              })()}
                            </tfoot>
                          </table>
                        </div>
                        
                        {/* Hinweis bei √úberschreitung */}
                        {(() => {
                          const plan = project.cost_plan as any;
                          const activePRs = paymentRequests.filter(pr => pr.status !== 'draft' && pr.status !== 'rejected');
                          const actualPersonnel = activePRs.reduce((sum, pr) => sum + (pr.personnel_costs || 0), 0);
                          const actualOverhead = activePRs.reduce((sum, pr) => sum + (pr.overhead_costs || 0), 0);
                          const actualThirdParty = activePRs.reduce((sum, pr) => sum + (pr.third_party_costs || 0), 0);
                          
                          const hasOverage = 
                            actualPersonnel > (plan.personnel_costs_planned || 0) ||
                            actualOverhead > (plan.overhead_costs_planned || 0) ||
                            actualThirdParty > (plan.third_party_costs_planned || 0);
                          
                          if (hasOverage) {
                            return (
                              <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p className="text-yellow-800 text-sm">
                                  <strong>‚ö†Ô∏è Hinweis:</strong> Bei einer oder mehreren Kostenpositionen wurde die geplante Summe √ºberschritten. 
                                  Die tats√§chlichen Kosten d√ºrfen √ºber der Planung liegen - die Zuwendung ist jedoch auf den bewilligten Betrag begrenzt.
                                </p>
                              </div>
                            );
                          }
                          return null;
                        })()}
                      </div>
                    )}

                    {canEdit && (
                      <div className="pt-4">
                        <button
                          onClick={() => setIsEditing(true)}
                          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                        >
                          F√∂rderdetails bearbeiten
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* ========== TAB: ZAHLUNGSANFORDERUNGEN ========== */}
            {activeTab === 'zahlungsanforderungen' && (
              <div>
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-lg font-semibold">Zahlungsanforderungen</h2>
                  {canEdit && project.funding_program && (
                    <button
                      onClick={() => setShowZAModal(true)}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center"
                    >
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                      Neue Zahlungsanforderung
                    </button>
                  )}
                </div>

                {!project.funding_program && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <p className="text-yellow-800">
                      ‚ö†Ô∏è Bitte konfigurieren Sie zuerst die F√∂rderdetails im Tab "F√∂rderung", um Zahlungsanforderungen erstellen zu k√∂nnen.
                    </p>
                  </div>
                )}

                {/* Funding Status Widget */}
                {project.funding_amount && (
                  <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mb-6">
                    <h3 className="font-medium text-gray-900 mb-4">F√∂rdermittel-Status</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                      <div>
                        <div className="text-sm text-gray-500">Bewilligt</div>
                        <div className="text-lg font-bold text-blue-600">{formatCurrency(fundingStatus.approved)}</div>
                      </div>
                      <div>
                        <div className="text-sm text-gray-500">Ausgezahlt</div>
                        <div className="text-lg font-bold text-green-600">{formatCurrency(fundingStatus.paid)}</div>
                      </div>
                      <div>
                        <div className="text-sm text-gray-500">In Pr√ºfung</div>
                        <div className="text-lg font-bold text-yellow-600">{formatCurrency(fundingStatus.pending)}</div>
                      </div>
                      <div>
                        <div className="text-sm text-gray-500">Verf√ºgbar</div>
                        <div className="text-lg font-bold text-gray-900">{formatCurrency(fundingStatus.available)}</div>
                      </div>
                    </div>
                    {/* Progress Bar */}
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div className="flex h-3 rounded-full overflow-hidden">
                        <div 
                          className="bg-green-500" 
                          style={{ width: `${(fundingStatus.paid / fundingStatus.approved) * 100}%` }}
                          title={`Ausgezahlt: ${formatCurrency(fundingStatus.paid)}`}
                        />
                        <div 
                          className="bg-yellow-400" 
                          style={{ width: `${(fundingStatus.pending / fundingStatus.approved) * 100}%` }}
                          title={`In Pr√ºfung: ${formatCurrency(fundingStatus.pending)}`}
                        />
                      </div>
                    </div>
                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                      <span>0%</span>
                      <span>{Math.round(((fundingStatus.paid + fundingStatus.pending) / fundingStatus.approved) * 100)}% abgerufen</span>
                      <span>100%</span>
                    </div>
                  </div>
                )}

                {/* ZA List */}
                {paymentRequests.length === 0 ? (
                  <div className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg">
                    <svg className="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p className="text-lg">Noch keine Zahlungsanforderungen</p>
                    <p className="text-sm mt-2">Erstellen Sie eine neue Zahlungsanforderung basierend auf den erfassten Zeiten.</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nr.</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zeitraum</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Stunden</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Personalkosten</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Angefordert</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ausgezahlt</th>
                          <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {paymentRequests.map((pr) => (
                          <tr 
                            key={pr.id} 
                            className="hover:bg-gray-50 cursor-pointer"
                            onClick={() => setSelectedZaId(pr.id)}
                          >
                            <td className="px-4 py-3 font-medium text-gray-900">
                              ZA-{pr.request_number}
                            </td>
                            <td className="px-4 py-3 text-gray-600">
                              {formatDate(pr.period_start)} - {formatDate(pr.period_end)}
                            </td>
                            <td className="px-4 py-3 text-right text-gray-600">
                              {pr.personnel_hours?.toFixed(1)}h
                            </td>
                            <td className="px-4 py-3 text-right text-gray-600">
                              {formatCurrency(pr.personnel_costs)}
                            </td>
                            <td className="px-4 py-3 text-right font-medium text-gray-900">
                              {formatCurrency(pr.requested_amount)}
                            </td>
                            <td className="px-4 py-3">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${getStatusColor(pr.status)}`}>
                                {getStatusLabel(pr.status)}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-right text-green-600 font-medium">
                              {pr.paid_amount ? formatCurrency(pr.paid_amount) : '-'}
                            </td>
                            <td className="px-4 py-3 text-right" onClick={(e) => e.stopPropagation()}>
                              <div className="flex justify-end space-x-2">
                                <button
                                  onClick={() => setSelectedZaId(pr.id)}
                                  className="text-blue-600 hover:text-blue-800 p-1"
                                  title="Details anzeigen"
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                  </svg>
                                </button>
                                {pr.status === 'draft' && canEdit && (
                                  <button
                                    onClick={() => handleDeleteZA(pr.id)}
                                    className="text-red-600 hover:text-red-800 p-1"
                                    title="L√∂schen"
                                  >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                  </button>
                                )}
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ========== MODAL: ZAHLUNGSANFORDERUNG ERSTELLEN ========== */}
      {showZAModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            {/* Modal Header */}
            <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
              <h3 className="text-xl font-bold text-gray-900">
                Neue Zahlungsanforderung erstellen
              </h3>
              <button
                onClick={() => {
                  setShowZAModal(false);
                  setZaFormData({ period_start: '', period_end: '' });
                  setZaCalculation(null);
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* Modal Body */}
            <div className="p-6">
              {/* Period Selection */}
              <div className="bg-blue-50 rounded-lg p-4 mb-6">
                <h4 className="font-medium text-blue-900 mb-4">Abrechnungszeitraum</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Von</label>
                    <input
                      type="date"
                      value={zaFormData.period_start}
                      onChange={(e) => setZaFormData({ ...zaFormData, period_start: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Bis</label>
                    <input
                      type="date"
                      value={zaFormData.period_end}
                      onChange={(e) => setZaFormData({ ...zaFormData, period_end: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
                <button
                  onClick={handleCalculateZA}
                  disabled={zaCalculating || !zaFormData.period_start || !zaFormData.period_end}
                  className="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400 flex items-center"
                >
                  {zaCalculating ? (
                    <>
                      <svg className="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                      </svg>
                      Berechne...
                    </>
                  ) : (
                    <>
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                      Kosten berechnen
                    </>
                  )}
                </button>
              </div>

              {/* Calculation Results */}
              {zaCalculation && (
                <>
                  {/* Anlage 1a Preview - Hours by Month */}
                  <div className="mb-6">
                    <h4 className="font-medium text-gray-900 mb-3">
                      üìã Anlage 1a - Abrechnung f√∂rderbarer Personenstunden
                    </h4>
                    <div className="overflow-x-auto border rounded-lg">
                      <table className="min-w-full divide-y divide-gray-200 text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-3 py-2 text-left font-medium text-gray-500">Nr.</th>
                            <th className="px-3 py-2 text-left font-medium text-gray-500">Mitarbeiter</th>
                            <th className="px-3 py-2 text-left font-medium text-gray-500">Gruppe</th>
                            {/* Dynamic month columns */}
                            {zaCalculation.items.length > 0 && 
                              Object.keys(zaCalculation.items[0].hours_by_month).sort().map(month => (
                                <th key={month} className="px-3 py-2 text-right font-medium text-gray-500">
                                  {new Date(month + '-01').toLocaleDateString('de-DE', { month: 'short', year: '2-digit' })}
                                </th>
                              ))
                            }
                            <th className="px-3 py-2 text-right font-medium text-gray-900 bg-gray-100">Œ£ Stunden</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {zaCalculation.items.map((item, idx) => (
                            <tr key={item.user_profile_id} className="hover:bg-gray-50">
                              <td className="px-3 py-2 text-gray-900">{item.employee_number || idx + 1}</td>
                              <td className="px-3 py-2 text-gray-900">{item.employee_name}</td>
                              <td className="px-3 py-2">
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">
                                  {item.qualification_group}
                                </span>
                              </td>
                              {Object.keys(item.hours_by_month).sort().map(month => (
                                <td key={month} className="px-3 py-2 text-right text-gray-600">
                                  {item.hours_by_month[month].toFixed(1)}
                                </td>
                              ))}
                              <td className="px-3 py-2 text-right font-medium text-gray-900 bg-gray-50">
                                {item.total_hours.toFixed(1)}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                        <tfoot className="bg-gray-100">
                          <tr>
                            <td colSpan={3} className="px-3 py-2 font-medium text-gray-900">Gesamt</td>
                            {zaCalculation.items.length > 0 && 
                              Object.keys(zaCalculation.items[0].hours_by_month).sort().map(month => {
                                const monthTotal = zaCalculation.items.reduce(
                                  (sum, item) => sum + (item.hours_by_month[month] || 0), 0
                                );
                                return (
                                  <td key={month} className="px-3 py-2 text-right font-medium text-gray-900">
                                    {monthTotal.toFixed(1)}
                                  </td>
                                );
                              })
                            }
                            <td className="px-3 py-2 text-right font-bold text-gray-900">
                              {zaCalculation.totals.personnel_hours.toFixed(1)}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>

                  {/* Anlage 1b Preview - Costs */}
                  <div className="mb-6">
                    <h4 className="font-medium text-gray-900 mb-3">
                      üìã Anlage 1b - Abrechnung zuwendungsf√§higer Personalkosten
                    </h4>
                    <div className="overflow-x-auto border rounded-lg">
                      <table className="min-w-full divide-y divide-gray-200 text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-3 py-2 text-left font-medium text-gray-500">Nr.</th>
                            <th className="px-3 py-2 text-left font-medium text-gray-500">Mitarbeiter</th>
                            <th className="px-3 py-2 text-left font-medium text-gray-500">Gruppe</th>
                            <th className="px-3 py-2 text-right font-medium text-gray-500">Stunden</th>
                            <th className="px-3 py-2 text-right font-medium text-gray-500">Stundensatz</th>
                            <th className="px-3 py-2 text-right font-medium text-gray-900 bg-gray-100">Personalkosten</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {zaCalculation.items.map((item, idx) => (
                            <tr key={item.user_profile_id} className="hover:bg-gray-50">
                              <td className="px-3 py-2 text-gray-900">{item.employee_number || idx + 1}</td>
                              <td className="px-3 py-2 text-gray-900">{item.employee_name}</td>
                              <td className="px-3 py-2">
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">
                                  {item.qualification_group}
                                </span>
                              </td>
                              <td className="px-3 py-2 text-right text-gray-600">{item.total_hours.toFixed(1)}</td>
                              <td className="px-3 py-2 text-right text-gray-600">{formatCurrency(item.hourly_rate)}</td>
                              <td className="px-3 py-2 text-right font-medium text-gray-900 bg-gray-50">
                                {formatCurrency(item.total_costs)}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                        <tfoot className="bg-gray-100">
                          <tr>
                            <td colSpan={3} className="px-3 py-2 font-medium text-gray-900">Gesamt</td>
                            <td className="px-3 py-2 text-right font-medium text-gray-900">
                              {zaCalculation.totals.personnel_hours.toFixed(1)}
                            </td>
                            <td className="px-3 py-2"></td>
                            <td className="px-3 py-2 text-right font-bold text-gray-900">
                              {formatCurrency(zaCalculation.totals.personnel_costs)}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>

                  {/* Summary */}
                  <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6">
                    <h4 className="font-medium text-gray-900 mb-4">üìä Zusammenfassung</h4>
                    <div className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Personalkosten</span>
                        <span className="font-medium">{formatCurrency(zaCalculation.totals.personnel_costs)}</span>
                      </div>
                      {(project.overhead_rate || 0) > 0 && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">+ Gemeinkostenzuschlag ({project.overhead_rate}%)</span>
                          <span className="font-medium">{formatCurrency(zaCalculation.totals.overhead_costs)}</span>
                        </div>
                      )}
                      <div className="flex justify-between border-t pt-2">
                        <span className="font-medium text-gray-900">= Zuwendungsf√§hige Kosten</span>
                        <span className="font-bold text-gray-900">{formatCurrency(zaCalculation.totals.total_eligible_costs)}</span>
                      </div>
                      <div className="flex justify-between text-sm text-gray-500">
                        <span>√ó F√∂rdersatz ({project.funding_rate || 50}%)</span>
                        <span></span>
                      </div>
                      <div className="flex justify-between text-lg border-t pt-2">
                        <span className="font-bold text-green-700">= Angeforderte Zuwendung</span>
                        <span className="font-bold text-green-700 text-xl">{formatCurrency(zaCalculation.totals.requested_amount)}</span>
                      </div>
                    </div>
                  </div>

                  {/* NEU: Budget-Warnungen */}
                  {(() => {
                    const warnings: string[] = [];
                    const zaYear = zaFormData.period_start ? new Date(zaFormData.period_start).getFullYear() : null;
                    
                    // 1. Jahresbudget pr√ºfen
                    if (zaYear && project.funding_yearly_budget) {
                      const yearBudget = (project.funding_yearly_budget as any)[zaYear] || 0;
                      if (yearBudget > 0) {
                        // Bisherige ZAs im selben Jahr (ohne draft/rejected)
                        const existingInYear = paymentRequests
                          .filter(pr => {
                            const prYear = new Date(pr.period_start).getFullYear();
                            return prYear === zaYear && pr.status !== 'draft' && pr.status !== 'rejected';
                          })
                          .reduce((sum, pr) => sum + (pr.requested_amount || 0), 0);
                        
                        const newTotal = existingInYear + zaCalculation.totals.requested_amount;
                        if (newTotal > yearBudget) {
                          warnings.push(`Die Gesamtanforderung f√ºr ${zaYear} (${formatCurrency(newTotal)}) √ºberschreitet das Jahresbudget (${formatCurrency(yearBudget)}) um ${formatCurrency(newTotal - yearBudget)}.`);
                        }
                      }
                    }
                    
                    // 2. Kostenplan pr√ºfen
                    if (project.cost_plan) {
                      const plan = project.cost_plan as any;
                      const activePRs = paymentRequests.filter(pr => pr.status !== 'draft' && pr.status !== 'rejected');
                      
                      // Personalkosten
                      const totalPersonnel = activePRs.reduce((sum, pr) => sum + (pr.personnel_costs || 0), 0) + zaCalculation.totals.personnel_costs;
                      if (plan.personnel_costs_planned && totalPersonnel > plan.personnel_costs_planned) {
                        warnings.push(`Personalkosten gesamt (${formatCurrency(totalPersonnel)}) √ºberschreiten die Planung (${formatCurrency(plan.personnel_costs_planned)}).`);
                      }
                      
                      // Gemeinkosten
                      const totalOverhead = activePRs.reduce((sum, pr) => sum + (pr.overhead_costs || 0), 0) + zaCalculation.totals.overhead_costs;
                      if (plan.overhead_costs_planned && totalOverhead > plan.overhead_costs_planned) {
                        warnings.push(`Gemeinkosten gesamt (${formatCurrency(totalOverhead)}) √ºberschreiten die Planung (${formatCurrency(plan.overhead_costs_planned)}).`);
                      }
                    }
                    
                    // 3. Gesamtf√∂rderung pr√ºfen
                    if (project.funding_amount) {
                      const totalRequested = paymentRequests
                        .filter(pr => pr.status !== 'draft' && pr.status !== 'rejected')
                        .reduce((sum, pr) => sum + (pr.requested_amount || 0), 0) + zaCalculation.totals.requested_amount;
                      
                      if (totalRequested > project.funding_amount) {
                        warnings.push(`Die Gesamtanforderung (${formatCurrency(totalRequested)}) √ºberschreitet die bewilligte F√∂rdersumme (${formatCurrency(project.funding_amount)}).`);
                      }
                    }
                    
                    if (warnings.length === 0) return null;
                    
                    return (
                      <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mt-4">
                        <h4 className="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Hinweise zur Budget√ºberschreitung</h4>
                        <ul className="list-disc list-inside text-sm text-yellow-700 space-y-1">
                          {warnings.map((w, i) => <li key={i}>{w}</li>)}
                        </ul>
                        <p className="text-xs text-yellow-600 mt-3">
                          Die Zahlungsanforderung kann trotzdem erstellt werden. Die tats√§chlichen Kosten d√ºrfen √ºber der Planung liegen,
                          die Auszahlung ist jedoch auf die bewilligte Summe begrenzt.
                        </p>
                      </div>
                    );
                  })()}
                </>
              )}
            </div>

            {/* Modal Footer */}
            <div className="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end space-x-3">
              <button
                onClick={() => {
                  setShowZAModal(false);
                  setZaFormData({ period_start: '', period_end: '' });
                  setZaCalculation(null);
                }}
                className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
              >
                Abbrechen
              </button>
              {zaCalculation && (
                <>
                  <button
                    onClick={() => handleSaveZA(true)}
                    disabled={saving}
                    className="px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 disabled:opacity-50"
                  >
                    Als Entwurf speichern
                  </button>
                  <button
                    onClick={() => handleSaveZA(false)}
                    disabled={saving}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg disabled:bg-gray-400"
                  >
                    {saving ? 'Speichern...' : 'Speichern & Berechnen'}
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ========== MODAL: ZAHLUNGSANFORDERUNG DETAIL ========== */}
      {selectedZaId && (
        <ZADetailModal
          zaId={selectedZaId}
          supabase={supabase}
          onClose={() => setSelectedZaId(null)}
          onUpdate={loadData}
          canEdit={canEdit}
          formatCurrency={formatCurrency}
          formatDate={formatDate}
        />
      )}
    </div>
  );
}

// ============================================
// ZA DETAIL MODAL COMPONENT
// ============================================

interface ZADetailModalProps {
  zaId: string;
  supabase: any;
  onClose: () => void;
  onUpdate: () => void;
  canEdit: boolean;
  formatCurrency: (amount: number | null | undefined) => string;
  formatDate: (dateStr: string | null | undefined) => string;
}

function ZADetailModal({ zaId, supabase, onClose, onUpdate, canEdit, formatCurrency, formatDate }: ZADetailModalProps) {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  
  const [za, setZa] = useState<any>(null);
  const [editMode, setEditMode] = useState(false);
  const [editData, setEditData] = useState({
    period_start: '',
    period_end: '',
    approved_amount: '',
    deductions: '',
    paid_amount: '',
    notes: '',
  });
  const [months, setMonths] = useState<string[]>([]);
  const [recalculating, setRecalculating] = useState(false);

  useEffect(() => {
    loadZA();
  }, [zaId]);

  const loadZA = async () => {
    try {
      setLoading(true);
      setError('');

      const { data: zaData, error: zaError } = await supabase
        .from('payment_requests')
        .select(`*, project:projects (name, funding_reference, funding_rate, overhead_rate)`)
        .eq('id', zaId)
        .single();

      if (zaError) throw zaError;

      const { data: items, error: itemsError } = await supabase
        .from('payment_request_items')
        .select('*')
        .eq('payment_request_id', zaId)
        .order('employee_number');

      if (itemsError) throw itemsError;

      const fullZa = { ...zaData, items: items || [] };
      setZa(fullZa);

      setEditData({
        period_start: fullZa.period_start || '',
        period_end: fullZa.period_end || '',
        approved_amount: fullZa.approved_amount?.toString() || '',
        deductions: fullZa.deductions?.toString() || '',
        paid_amount: fullZa.paid_amount?.toString() || '',
        notes: fullZa.notes || '',
      });

      const allMonths = new Set<string>();
      (items || []).forEach((item: any) => {
        Object.keys(item.hours_by_month || {}).forEach(m => allMonths.add(m));
      });
      setMonths(Array.from(allMonths).sort());

    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const getZAStatusConfig = (status: string) => {
    const configs: Record<string, { color: string; label: string; icon: string; next: string[] }> = {
      draft: { color: 'bg-gray-100 text-gray-800', label: 'Entwurf', icon: 'üìù', next: ['submitted'] },
      calculated: { color: 'bg-blue-100 text-blue-800', label: 'Berechnet', icon: 'üî¢', next: ['submitted'] },
      submitted: { color: 'bg-yellow-100 text-yellow-800', label: 'Eingereicht', icon: 'üì§', next: ['draft', 'in_review', 'approved'] },
      in_review: { color: 'bg-orange-100 text-orange-800', label: 'In Pr√ºfung', icon: '‚è≥', next: ['draft', 'approved', 'rejected'] },
      approved: { color: 'bg-green-100 text-green-800', label: 'Bewilligt', icon: '‚úÖ', next: ['paid'] },
      paid: { color: 'bg-emerald-100 text-emerald-800', label: 'Ausgezahlt', icon: 'üí∞', next: [] },
      rejected: { color: 'bg-red-100 text-red-800', label: 'Abgelehnt', icon: '‚ùå', next: ['draft'] },
      partial: { color: 'bg-purple-100 text-purple-800', label: 'Teilweise', icon: 'üìä', next: ['paid'] },
    };
    return configs[status] || configs.draft;
  };

  const handleStatusChange = async (newStatus: string) => {
    if (!za) return;
    setSaving(true);
    setError('');
    
    try {
      const updates: any = { status: newStatus, updated_at: new Date().toISOString() };
      
      // Bei Zur√ºcksetzen auf Entwurf: Timestamps l√∂schen
      if (newStatus === 'draft') {
        updates.submitted_at = null;
        updates.approved_at = null;
        updates.paid_at = null;
      }
      
      if (newStatus === 'submitted') {
        updates.submitted_at = new Date().toISOString();
      } else if (newStatus === 'approved' || newStatus === 'partial') {
        updates.approved_at = new Date().toISOString();
        if (editData.approved_amount) {
          updates.approved_amount = parseFloat(editData.approved_amount);
        } else {
          updates.approved_amount = za.requested_amount;
        }
      } else if (newStatus === 'paid') {
        updates.paid_at = new Date().toISOString();
        if (editData.paid_amount) {
          updates.paid_amount = parseFloat(editData.paid_amount);
        } else {
          updates.paid_amount = za.approved_amount || za.requested_amount;
        }
      }

      const { error: updateError } = await supabase
        .from('payment_requests')
        .update(updates)
        .eq('id', za.id);

      if (updateError) throw updateError;

      setSuccess(`Status auf "${getZAStatusConfig(newStatus).label}" ge√§ndert`);
      loadZA();
      onUpdate();
      setTimeout(() => setSuccess(''), 3000);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setSaving(false);
    }
  };

  const handleSaveDetails = async () => {
    if (!za) return;
    setSaving(true);
    setError('');

    try {
      const updates: any = { 
        notes: editData.notes || null, 
        updated_at: new Date().toISOString() 
      };

      // F√ºr Entw√ºrfe: auch Zeitraum speichern
      if (za.status === 'draft' || za.status === 'calculated') {
        if (editData.period_start) updates.period_start = editData.period_start;
        if (editData.period_end) updates.period_end = editData.period_end;
      }

      if (editData.approved_amount) updates.approved_amount = parseFloat(editData.approved_amount);
      if (editData.deductions) updates.deductions = parseFloat(editData.deductions);
      if (editData.paid_amount) updates.paid_amount = parseFloat(editData.paid_amount);

      const { error: updateError } = await supabase
        .from('payment_requests')
        .update(updates)
        .eq('id', za.id);

      if (updateError) throw updateError;

      setSuccess('√Ñnderungen gespeichert');
      setEditMode(false);
      loadZA();
      onUpdate();
      setTimeout(() => setSuccess(''), 3000);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setSaving(false);
    }
  };

  // Neu berechnen f√ºr Entw√ºrfe
  const handleRecalculate = async () => {
    if (!za || !editData.period_start || !editData.period_end) {
      setError('Bitte Start- und Enddatum angeben');
      return;
    }

    setRecalculating(true);
    setError('');

    try {
      // 1. Projekt-Zuordnungen laden
      const { data: projectAssignments } = await supabase
        .from('project_assignments')
        .select('user_profile_id, project_employee_number')
        .eq('project_id', za.project_id);

      const assignmentMap: Record<string, number> = {};
      const assignedUserIds = new Set<string>();
      (projectAssignments || []).forEach((pa: any) => {
        assignmentMap[pa.user_profile_id] = pa.project_employee_number;
        assignedUserIds.add(pa.user_profile_id);
      });

      if (assignedUserIds.size === 0) {
        setError('Keine Projektmitarbeiter zugeordnet');
        setRecalculating(false);
        return;
      }

      // 2. Zeiteintr√§ge laden
      const { data: timeEntries, error: teError } = await supabase
        .from('time_entries')
        .select(`*, user_profile:user_profiles (id, name, qualification_group)`)
        .eq('project_id', za.project_id)
        .eq('category', 'project_work')
        .gte('entry_date', editData.period_start)
        .lte('entry_date', editData.period_end)
        .in('user_profile_id', Array.from(assignedUserIds));

      if (teError) throw teError;

      // 3. Gruppieren nach MA und Monat
      const employeeData: Record<string, any> = {};
      (timeEntries || []).forEach((entry: any) => {
        const upId = entry.user_profile_id;
        const monthKey = entry.entry_date.substring(0, 7);

        if (!employeeData[upId]) {
          employeeData[upId] = {
            user_profile_id: upId,
            name: entry.user_profile?.name || 'Unbekannt',
            qualification_group: entry.user_profile?.qualification_group || 'C',
            hours_by_month: {},
            total_hours: 0,
          };
        }

        if (!employeeData[upId].hours_by_month[monthKey]) {
          employeeData[upId].hours_by_month[monthKey] = 0;
        }

        employeeData[upId].hours_by_month[monthKey] += Number(entry.hours);
        employeeData[upId].total_hours += Number(entry.hours);
      });

      // 4. Gehaltsdaten laden
      const year = new Date(editData.period_start).getFullYear();
      const userIds = Object.keys(employeeData);

      const { data: salaryData } = await supabase
        .from('salary_components')
        .select('user_profile_id, hourly_rate')
        .in('user_profile_id', userIds.length > 0 ? userIds : ['none'])
        .eq('year', year);

      const salaryMap: Record<string, number> = {};
      (salaryData || []).forEach((s: any) => {
        salaryMap[s.user_profile_id] = Number(s.hourly_rate) || 50;
      });

      // 5. Items erstellen
      const newItems = Object.values(employeeData)
        .filter((emp: any) => assignedUserIds.has(emp.user_profile_id))
        .map((emp: any) => ({
          user_profile_id: emp.user_profile_id,
          employee_number: assignmentMap[emp.user_profile_id] || 0,
          employee_name: emp.name,
          qualification_group: emp.qualification_group,
          hours_by_month: emp.hours_by_month,
          total_hours: emp.total_hours,
          hourly_rate: salaryMap[emp.user_profile_id] || 50,
          total_costs: emp.total_hours * (salaryMap[emp.user_profile_id] || 50),
        }));

      // 6. Summen berechnen
      const personnel_hours = newItems.reduce((sum: number, i: any) => sum + i.total_hours, 0);
      const personnel_costs = newItems.reduce((sum: number, i: any) => sum + i.total_costs, 0);
      const overhead_rate = za.project?.overhead_rate || 0;
      const overhead_costs = personnel_costs * (overhead_rate / 100);
      const total_eligible_costs = personnel_costs + overhead_costs;
      const funding_rate = za.funding_rate_applied || 50;
      const requested_amount = total_eligible_costs * (funding_rate / 100);

      // 7. Payment Request updaten
      const { error: updateError } = await supabase
        .from('payment_requests')
        .update({
          period_start: editData.period_start,
          period_end: editData.period_end,
          personnel_hours,
          personnel_costs,
          overhead_costs,
          total_eligible_costs,
          requested_amount,
          calculated_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
        })
        .eq('id', za.id);

      if (updateError) throw updateError;

      // 8. Alte Items l√∂schen
      await supabase
        .from('payment_request_items')
        .delete()
        .eq('payment_request_id', za.id);

      // 9. Neue Items einf√ºgen
      if (newItems.length > 0) {
        const itemsToInsert = newItems.map((item: any) => ({
          payment_request_id: za.id,
          user_profile_id: item.user_profile_id,
          employee_number: item.employee_number,
          employee_name: item.employee_name,
          qualification_group: item.qualification_group,
          hours_by_month: item.hours_by_month,
          total_hours: item.total_hours,
          hourly_rate: item.hourly_rate,
          total_costs: item.total_costs,
        }));

        await supabase.from('payment_request_items').insert(itemsToInsert);
      }

      setSuccess('Neu berechnet!');
      setEditMode(false);
      loadZA();
      onUpdate();
      setTimeout(() => setSuccess(''), 3000);

    } catch (err: any) {
      setError(err.message);
    } finally {
      setRecalculating(false);
    }
  };

  // ZA l√∂schen (nur Entw√ºrfe)
  const handleDelete = async () => {
    if (!za || za.status !== 'draft') return;
    if (!confirm('Zahlungsanforderung wirklich l√∂schen?')) return;

    setSaving(true);
    try {
      await supabase.from('payment_request_items').delete().eq('payment_request_id', za.id);
      await supabase.from('payment_requests').delete().eq('id', za.id);
      
      setSuccess('Gel√∂scht');
      onUpdate();
      onClose();
    } catch (err: any) {
      setError(err.message);
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-8 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Lade Details...</p>
        </div>
      </div>
    );
  }

  if (!za) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-8 text-center">
          <p className="text-red-600 mb-4">Zahlungsanforderung nicht gefunden</p>
          <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-lg">Schlie√üen</button>
        </div>
      </div>
    );
  }

  const statusConfig = getZAStatusConfig(za.status);

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold">Zahlungsanforderung Nr. {za.request_number}</h2>
            <p className="text-blue-100 text-sm">{za.project?.name} ‚Ä¢ {za.project?.funding_reference}</p>
          </div>
          <button onClick={onClose} className="text-white hover:text-blue-200 text-2xl">√ó</button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {error && <div className="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
          {success && <div className="mb-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">{success}</div>}

          {/* Status & Actions */}
          <div className="bg-gray-50 rounded-lg p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
            <div className="flex items-center space-x-4">
              <span className={`px-4 py-2 rounded-full text-lg font-medium ${statusConfig.color}`}>
                {statusConfig.icon} {statusConfig.label}
              </span>
              <div className="text-sm text-gray-500">
                {za.submitted_at && <div>Eingereicht: {formatDate(za.submitted_at)}</div>}
                {za.approved_at && <div>Bewilligt: {formatDate(za.approved_at)}</div>}
                {za.paid_at && <div>Ausgezahlt: {formatDate(za.paid_at)}</div>}
              </div>
            </div>
            
            <div className="flex flex-wrap gap-2">
              {/* Bearbeiten-Button f√ºr Entw√ºrfe */}
              {canEdit && (za.status === 'draft' || za.status === 'calculated') && !editMode && (
                <button
                  onClick={() => setEditMode(true)}
                  className="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300"
                >
                  ‚úèÔ∏è Bearbeiten
                </button>
              )}
              
              {/* L√∂schen-Button f√ºr Entw√ºrfe */}
              {canEdit && za.status === 'draft' && !editMode && (
                <button
                  onClick={handleDelete}
                  disabled={saving}
                  className="px-3 py-1.5 rounded-lg text-sm font-medium bg-red-100 text-red-700 hover:bg-red-200"
                >
                  üóëÔ∏è L√∂schen
                </button>
              )}
              
              {/* Status-√Ñnderungen */}
              {canEdit && statusConfig.next.length > 0 && !editMode && (
                <>
                  {statusConfig.next.map(action => {
                    const actionConfig = getZAStatusConfig(action);
                    return (
                      <button
                        key={action}
                        onClick={() => handleStatusChange(action)}
                        disabled={saving}
                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                          action === 'rejected' 
                            ? 'bg-red-100 text-red-700 hover:bg-red-200'
                            : action === 'paid'
                            ? 'bg-green-600 text-white hover:bg-green-700'
                            : action === 'draft'
                            ? 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                        }`}
                      >
                        {action === 'draft' ? '‚Üê Zur√ºck zu ' : '‚Üí '}{actionConfig.label}
                      </button>
                    );
                  })}
                </>
              )}
            </div>
          </div>

          {/* Entwurf-Bearbeitung */}
          {editMode && (za.status === 'draft' || za.status === 'calculated') && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
              <h4 className="font-medium text-yellow-800 mb-4">‚úèÔ∏è Entwurf bearbeiten</h4>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Zeitraum von</label>
                  <input
                    type="date"
                    value={editData.period_start}
                    onChange={e => setEditData({...editData, period_start: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Zeitraum bis</label>
                  <input
                    type="date"
                    value={editData.period_end}
                    onChange={e => setEditData({...editData, period_end: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">Notizen</label>
                <textarea
                  value={editData.notes}
                  onChange={e => setEditData({...editData, notes: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  rows={2}
                  placeholder="Interne Notizen..."
                />
              </div>
              <div className="flex justify-end gap-2">
                <button
                  onClick={() => setEditMode(false)}
                  className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                >
                  Abbrechen
                </button>
                <button
                  onClick={handleRecalculate}
                  disabled={recalculating}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center"
                >
                  {recalculating ? (
                    <>
                      <svg className="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                      </svg>
                      Berechne...
                    </>
                  ) : (
                    <>üîÑ Neu berechnen</>
                  )}
                </button>
              </div>
            </div>
          )}

          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-blue-50 rounded-lg p-4">
              <div className="text-sm text-blue-600">Zeitraum</div>
              <div className="font-medium text-blue-900">{formatDate(za.period_start)} - {formatDate(za.period_end)}</div>
            </div>
            <div className="bg-purple-50 rounded-lg p-4">
              <div className="text-sm text-purple-600">Stunden</div>
              <div className="font-bold text-xl text-purple-900">{za.personnel_hours?.toFixed(1)}h</div>
            </div>
            <div className="bg-amber-50 rounded-lg p-4">
              <div className="text-sm text-amber-600">Personalkosten</div>
              <div className="font-bold text-xl text-amber-900">{formatCurrency(za.personnel_costs)}</div>
            </div>
            <div className="bg-green-50 rounded-lg p-4">
              <div className="text-sm text-green-600">Angefordert</div>
              <div className="font-bold text-xl text-green-900">{formatCurrency(za.requested_amount)}</div>
            </div>
          </div>

          {/* Anlage 1a - Stunden */}
          <div className="mb-6">
            <h3 className="font-medium text-gray-900 mb-3">üìã Anlage 1a - Abrechnung f√∂rderbarer Personenstunden</h3>
            <div className="overflow-x-auto border rounded-lg">
              <table className="min-w-full divide-y divide-gray-200 text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left font-medium text-gray-500">Nr.</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500">Mitarbeiter</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500">Gruppe</th>
                    {months.map(month => (
                      <th key={month} className="px-3 py-2 text-right font-medium text-gray-500">
                        {new Date(month + '-01').toLocaleDateString('de-DE', { month: 'short', year: '2-digit' })}
                      </th>
                    ))}
                    <th className="px-3 py-2 text-right font-medium text-gray-900 bg-gray-100">Œ£</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {(za.items || []).map((item: any, idx: number) => (
                    <tr key={idx} className="hover:bg-gray-50">
                      <td className="px-3 py-2 font-medium">{item.employee_number || idx + 1}</td>
                      <td className="px-3 py-2">{item.employee_name}</td>
                      <td className="px-3 py-2">
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">{item.qualification_group}</span>
                      </td>
                      {months.map(month => (
                        <td key={month} className="px-3 py-2 text-right text-gray-600">
                          {(item.hours_by_month?.[month] || 0).toFixed(1)}
                        </td>
                      ))}
                      <td className="px-3 py-2 text-right font-medium bg-gray-50">{item.total_hours.toFixed(1)}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot className="bg-gray-100">
                  <tr>
                    <td colSpan={3} className="px-3 py-2 font-medium">Gesamt</td>
                    {months.map(month => {
                      const total = (za.items || []).reduce((sum: number, item: any) => sum + (item.hours_by_month?.[month] || 0), 0);
                      return <td key={month} className="px-3 py-2 text-right font-medium">{total.toFixed(1)}</td>;
                    })}
                    <td className="px-3 py-2 text-right font-bold">{za.personnel_hours?.toFixed(1)}h</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* Anlage 1b - Kosten */}
          <div className="mb-6">
            <h3 className="font-medium text-gray-900 mb-3">üìã Anlage 1b - Abrechnung zuwendungsf√§higer Personalkosten</h3>
            <div className="overflow-x-auto border rounded-lg">
              <table className="min-w-full divide-y divide-gray-200 text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left font-medium text-gray-500">Nr.</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500">Mitarbeiter</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500">Gruppe</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500">Stunden</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500">Stundensatz</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-900 bg-gray-100">Personalkosten</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {(za.items || []).map((item: any, idx: number) => (
                    <tr key={idx} className="hover:bg-gray-50">
                      <td className="px-3 py-2 font-medium">{item.employee_number || idx + 1}</td>
                      <td className="px-3 py-2">{item.employee_name}</td>
                      <td className="px-3 py-2">
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">{item.qualification_group}</span>
                      </td>
                      <td className="px-3 py-2 text-right">{item.total_hours.toFixed(1)}</td>
                      <td className="px-3 py-2 text-right">{formatCurrency(item.hourly_rate)}</td>
                      <td className="px-3 py-2 text-right font-medium bg-gray-50">{formatCurrency(item.total_costs)}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot className="bg-gray-100">
                  <tr>
                    <td colSpan={3} className="px-3 py-2 font-medium">Gesamt</td>
                    <td className="px-3 py-2 text-right font-medium">{za.personnel_hours?.toFixed(1)}h</td>
                    <td></td>
                    <td className="px-3 py-2 text-right font-bold">{formatCurrency(za.personnel_costs)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* Kosten√ºbersicht & Bewilligung */}
          <div className="grid md:grid-cols-2 gap-6 mb-6">
            <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-6">
              <h4 className="font-medium text-gray-900 mb-4">üìä Kosten√ºbersicht</h4>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between"><span>Personalkosten</span><span className="font-medium">{formatCurrency(za.personnel_costs)}</span></div>
                {za.overhead_costs > 0 && (
                  <div className="flex justify-between text-gray-600"><span>+ Gemeinkostenzuschlag</span><span>{formatCurrency(za.overhead_costs)}</span></div>
                )}
                <div className="border-t pt-2 flex justify-between font-medium"><span>= Zuwendungsf√§hige Kosten</span><span>{formatCurrency(za.total_eligible_costs)}</span></div>
                <div className="flex justify-between text-gray-500"><span>√ó F√∂rdersatz ({za.funding_rate_applied}%)</span></div>
                <div className="border-t pt-2 flex justify-between text-lg"><span className="font-bold text-green-700">= Angeforderte Zuwendung</span><span className="font-bold text-green-700">{formatCurrency(za.requested_amount)}</span></div>
              </div>
            </div>

            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-6">
              <div className="flex justify-between items-center mb-4">
                <h4 className="font-medium text-gray-900">üí∞ Bewilligung & Auszahlung</h4>
                {canEdit && !editMode && ['approved', 'paid', 'partial'].includes(za.status) && (
                  <button onClick={() => setEditMode(true)} className="text-sm text-blue-600 hover:text-blue-800">Bearbeiten</button>
                )}
              </div>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span>Bewilligter Betrag</span>
                  {editMode ? (
                    <input type="number" value={editData.approved_amount} onChange={e => setEditData({...editData, approved_amount: e.target.value})} className="w-32 px-2 py-1 border rounded text-right" step="0.01" />
                  ) : (
                    <span className="font-medium">{formatCurrency(za.approved_amount)}</span>
                  )}
                </div>
                <div className="flex justify-between">
                  <span>- K√ºrzungen</span>
                  {editMode ? (
                    <input type="number" value={editData.deductions} onChange={e => setEditData({...editData, deductions: e.target.value})} className="w-32 px-2 py-1 border rounded text-right" step="0.01" />
                  ) : (
                    <span>{za.deductions ? formatCurrency(za.deductions) : '-'}</span>
                  )}
                </div>
                <div className="border-t pt-2 flex justify-between">
                  <span className="font-medium">Ausgezahlter Betrag</span>
                  {editMode ? (
                    <input type="number" value={editData.paid_amount} onChange={e => setEditData({...editData, paid_amount: e.target.value})} className="w-32 px-2 py-1 border rounded text-right" step="0.01" />
                  ) : (
                    <span className="font-bold text-green-700">{formatCurrency(za.paid_amount)}</span>
                  )}
                </div>
              </div>
              {editMode && (
                <div className="mt-4 flex justify-end gap-2">
                  <button onClick={() => setEditMode(false)} className="px-3 py-1.5 border rounded text-gray-600 hover:bg-gray-50">Abbrechen</button>
                  <button onClick={handleSaveDetails} disabled={saving} className="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400">
                    {saving ? 'Speichern...' : 'Speichern'}
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Notizen */}
          <div className="bg-gray-50 rounded-lg p-4">
            <h4 className="font-medium text-gray-900 mb-2">üìù Notizen</h4>
            {editMode ? (
              <textarea
                value={editData.notes}
                onChange={e => setEditData({...editData, notes: e.target.value})}
                className="w-full px-3 py-2 border rounded-lg"
                rows={3}
                placeholder="Interne Notizen..."
              />
            ) : (
              <p className="text-gray-600">{za.notes || 'Keine Notizen'}</p>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="border-t px-6 py-4 bg-gray-50 flex justify-end space-x-3">
          <button onClick={onClose} className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
            Schlie√üen
          </button>
        </div>
      </div>
    </div>
  );
}